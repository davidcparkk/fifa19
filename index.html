<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Fifa 19 Data Viz</title>

  <style>
    .body{
      background: blue;
    }
    .node {
      font: 17px sans-serif;
      fill: #1a761a;
    }
    .node:hover{
      cursor: pointer;
    }

    .link {
      stroke: #1bc51b;
      stroke-opacity: 0.5;
      fill: none;
      pointer-events: none;
    }

    .title{
      display: block;
      font-size: 50px;
      font-weight: bold;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin-bottom: 20px;
    }

    #main-container{
      display: flex;
      justify-content: center;
    }

    div.tooltip {	
      position: absolute;			
      text-align: center;	
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;		
      width: 180px;					
      height: 260px;					
      padding: 2px;				
      font: 17px sans-serif;		
      background: #E8E8E8;	
      border: 1px solid #dcdcdc;		
      border-radius: 8px;			
      pointer-events: none;			
    }
    </style>
</head>
<body>
  <script src="dist/bundle.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  
  <div class="title">FIFA19 Visualized</div>
  <img src="" class="background-image">
  
  <div class="wrapper">
    <div class="row" id="main-container">
      <div id="fifa19-bundle"></div>
      <div class="bundle-details"></div>
    </div>
  </div>

  <script>

    let diameter = 960,
    radius = diameter / 2,
    innerRadius = radius - 120;

    let cluster = d3.cluster()
        .size([360, innerRadius]);

    let line = d3.radialLine()
        .curve(d3.curveBundle.beta(0.85))
        .radius(function(d) { return d.y; })
        .angle(function(d) { return d.x / 180 * Math.PI; });

    let svg = d3.select("#fifa19-bundle").append("svg")
        .attr("width", diameter)
        .attr("height", diameter)
      .append("g")
        .attr("transform", "translate(" + radius + "," + radius + ")");

    let link = svg.append("g").selectAll(".link"),
        node = svg.append("g").selectAll(".node");

    let div = d3.select("#fifa19-bundle").append("div")	
      .attr("class", "tooltip")				
      .style("opacity", 0);

    d3.json("fifa_data_clean2.json", function(error, classes) {
      if (error) throw error;
      
      let root = packageHierarchy(classes)
          .sum(function(d) {  return d.size; });
          // debugger
      cluster(root);

      link = link
        .data(packageImports(root.leaves()))
        .enter().append("path")
          .each(function(d) { d.source = d[0], d.target = d[d.length - 1]; })
          .attr("class", "link")
          .attr("d", line);

      node = node
        .data(root.leaves())
        .enter().append("text")
          .attr("class", "node")
          .attr("dy", "0.31em")
          .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + 8) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
          .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
          .text(function(d) { return d.data.key; })
          .style("fill", function(d){
            if (d.data.nodeType=="player"){
              return 'blue';
            } else if (d.data.nodeType=="nation") {
              return 'green';
            } else if (d.data.nodeType=="club") {
              return 'orange';
            } else if (d.data.nodeType=="foot") {
              return 'purple';
            } else if (d.data.nodeType=="position") {
              return 'black';
            }
          })
        .on("mouseover", function(d){
          d3.selectAll(".node").style("fill", "#e0e0e0");
          d3.selectAll(".link").style("stroke", "#e0e0e0");
          
          colorNode(d.data.name);

          d.data.imports.forEach(function(name){
            colorNode(name);
            colorLink(d.data.name, name);
          });

          div.transition()		
              .duration(200)		
              .style("opacity", .9);		
          div.html("hello")	
              .style("left", (d3.event.pageX + 50) + "px")		
              .style("top", (d3.event.pageY - 60) + "px");	
          })	
        
        .on("mouseout", function(d){
          d3.selectAll(".node")
          .style("fill", function(d){
            if (d.data.nodeType=="player"){
              return 'blue';
            } else if (d.data.nodeType=="nation") {
              return 'green';
            } else if (d.data.nodeType=="club") {
              return 'orange';
            } else if (d.data.nodeType=="foot") {
              return 'purple';
            } else if (d.data.nodeType=="position") {
              return 'black';
            }
          });
          d3.selectAll(".link").style("stroke", "#1bc51b");

          div.transition()		
            .duration(500)		
            .style("opacity", 0);	
        });
    });

    function packageHierarchy(classes) {
      let map = {};

      function find(name, data) {
        let node = map[name], i;
        if (!node) {
          node = map[name] = data || {name: name, children: []};
          if (name.length) {
            node.parent = find(name.substring(0, i = name.lastIndexOf(".")));
            node.parent.children.push(node);
            node.key = name.substring(i + 1);
            if (node.name.includes('player')) {
              node.nodeType = 'player';
            } else if (node.name.includes('nation')){
              node.nodeType = 'nation';
            } else if (node.name.includes('club')){
              node.nodeType = 'club';
            } else if (node.name.includes('foot')){
              node.nodeType = 'foot';
            } else if (node.name.includes('position')){
              node.nodeType = 'position';
            }
          }
        }
        // debugger
        return node;
      }

      classes.forEach(function(d) {
        find(d.name, d);
      });

      return d3.hierarchy(map[""]);
    }

    function packageImports(nodes) {
      let map = {},
          imports = [];

      nodes.forEach(function(d) {
        map[d.data.name] = d;
      });

      nodes.forEach(function(d) {
        if (d.data.imports) d.data.imports.forEach(function(i) {
          imports.push(map[d.data.name].path(map[i]));
        });
      });

      return imports;
    }

    function colorLink(src,tgt){
      let link_selections = d3.selectAll(".link");
      let link = link_selections.nodes().filter(function(d){
        return (d3.select(d).data()[0].source.data.name == src && d3.select(d).data()[0].target.data.name == tgt);
      });
      d3.selectAll(link).style("stroke", "red");
    }

    function colorNode(name){
      let node_selections = d3.selectAll(".node");
      let node = node_selections.nodes().filter(function(d){
        return d3.select(d).data()[0].data.name == name;
      });
      d3.selectAll(node).style("fill", "red");
    }
    </script>

</body>
</html>